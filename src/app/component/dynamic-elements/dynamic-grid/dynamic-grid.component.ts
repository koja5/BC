import { Component, ElementRef, Input, OnInit, ViewChild } from "@angular/core";
import { FormGroup, Validators } from "@angular/forms";
import {
  DialogEditEventArgs,
  EditSettingsModel,
  SaveEventArgs,
  ToolbarItems,
} from "@syncfusion/ej2-angular-grids";
import { DynamicService } from "src/app/services/dynamic.service";
import { DynamicFormsComponent } from "../dynamic-forms/dynamic-forms.component";
import { FieldConfig } from "../dynamic-forms/models/field-config";
import { GridComponent } from "@syncfusion/ej2-angular-grids";
import { DialogComponent } from "@syncfusion/ej2-angular-popups";
import { HelpService } from "src/app/services/help.service";
import { QueryCellInfoEventArgs } from '@syncfusion/ej2-angular-grids';
import { Tooltip } from '@syncfusion/ej2-popups';

@Component({
  selector: "app-dynamic-grid",
  templateUrl: "./dynamic-grid.component.html",
  styleUrls: ["./dynamic-grid.component.scss"],
})
export class DynamicGridComponent implements OnInit {
  @Input() path: string;
  @Input() name: string;
  @ViewChild(DynamicFormsComponent, { static: false }) form: DynamicFormsComponent;
  @ViewChild("orderForm", { static: false }) public orderForm: FormGroup;
  @ViewChild("editSettingsTemplate", { static: false }) editSettingsTemplate: DialogComponent;
  @ViewChild("grid", { static: false }) public grid: GridComponent;
  @ViewChild("container", { static: false }) public container: ElementRef;

  public config: any;
  public toolbar: ToolbarItems[];
  public editSettings: EditSettingsModel;
  public data: any;
  public dataForm: any;
  public orderData: IOrderModel;
  public typeOfModification = "add";
  public operations: any;
  public sortSettings = [
    {
      field: "id",
      direction: "Descending",
    },
  ];
  public configField: FieldConfig[];

  constructor(
    private service: DynamicService,
    private helpService: HelpService
  ) { }

  ngOnInit() {
    this.initialization();
    this.editSettings = {
      allowEditing: true,
      allowAdding: true,
      allowDeleting: true,
      showDeleteConfirmDialog: true,
      mode: "Dialog",
    };
    this.toolbar = ["Add", "Edit", "Delete"];
    console.log(this.container);
    this.container.nativeElement.style.height = this.helpService.getHeightForGrid();
  }

  ngAfterViewInit() { }

  initialization() {
    this.service.getConfiguration(this.path, this.name).subscribe((data) => {
      this.config = data;
      this.callApi(data["request"]);
    });
  }

  callApi(data) {
    if (data.type === "POST") {
      this.callApiPost(data.api, data.body);
    } else {
      this.callApiGet(data.api, data.parameters);
    }
  }

  callApiPost(api, body) {
    this.service.callApiPost(api, body).subscribe((data) => { });
  }

  callApiGet(api, parameters) {
    this.service.callApiGet(api, parameters).subscribe((data) => {
      this.data = data;
    });
  }

  actionBegin(args: SaveEventArgs): void {
    console.log(args);
    /*if (args.requestType === "beginEdit" || args.requestType === "add") {
      this.orderData = Object.assign({}, args.rowData);
    }
    if (args.requestType === "save") {
      console.log(this.dataForm);
      if (this.orderForm.valid) {
        args.data = this.orderData;
      } else {
        args.cancel = true;
      }
    }*/
    /*if (args.requestType === "beginEdit" || args.requestType === "add") { 
        // set buttons here.... 
        args.dialog.buttons = [ ];
      } */
  }

  actionComplete(args: DialogEditEventArgs): void {
    console.log(args);
    if (args.requestType === "beginEdit" || args.requestType === "add") {
      args.dialog.buttons = [];
      setTimeout(() => {
        this.setValue(this.config.configField, args.rowData);
      }, 50);
    }

    if (args.requestType === "delete") {
      this.deleteData(args["data"][0]);
    }

    this.typeOfModification = args.requestType;
    this.operations = args;
    /*
      setTimeout(() => {
        let previousValid = this.form.valid;
        this.form.changes.subscribe(() => {
          if (this.form.valid !== previousValid) {
            previousValid = this.form.valid;
            this.form.setDisabled("submit", !previousValid);
          }
        });

        this.form.setDisabled("submit", true);
        this.form.setValue("storename", "Todd Motto");
      }, 100);*/
    /*if (args.requestType === "beginEdit" || args.requestType === "add") { 
        // set buttons here.... 
        args.dialog.buttons = [ ];
      } */
  }
  submitEmitter(event) {
    if (this.typeOfModification === "add") {
      this.service.callApiPost("/api/createToDo", event).subscribe((data) => {
        console.log(data);
      });
    } else if (this.typeOfModification === "beginEdit") {
      this.service.callApiPost("/api/updateToDo", event).subscribe((data) => {
        console.log(data);
      });
    }

    this.operations.dialog.close();
    this.initialization();
  }

  deleteData(event) {
    this.service.callApiGet("/api/deleteTodo", event.id).subscribe((data) => {
      console.log(data);
    });
  }

  setValue(fields, values) {
    for (let i = 0; i < fields.length; i++) {
      this.form.setValue(fields[i]["name"], values[fields[i]["name"]]);
    }
  }

  /* tooltip */
  tooltip(args: QueryCellInfoEventArgs) {
    const tooltip: Tooltip = new Tooltip(
      {
        content: args.data[args.column.field].toString(),
      },
      args.cell as HTMLTableCellElement
    );
  }
  /* tooltip END */
}

export interface IOrderModel {
  OrderID?: number;
  CustomerID?: string;
  ShipCity?: string;
  OrderDate?: Date;
  Freight?: number;
  ShipCountry?: string;
  ShipAddress?: string;
}
